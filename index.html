<!DOCTYPE html>
<html lang="ja">
<head>
    <title>テキスト認識</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no, minimal-ui">    
    
    <style>
        body {
            text-align: center;
        }
        
        img {
            max-height:960px;
            max-width:540px;
            height:auto;
            width:auto;
        }
        .resultTableContent {
            height:30px;
            border: 3px solid #003A76;
            border-radius: 4px;
        }

        .resultTableContentTarget {
            height:30px;
            border: 3px solid #003A76;
            border-radius: 4px;
            background-color: yellow;
        }

        #textTable {
            width:50%;
            margin: auto;
        }
    </style>
    
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/highcharts-more.js"></script>
</head>

<body>
    <div>
        <label for="picture">認識するテキストをカメラで撮影してください。</label>
    </div>
    <div>
        <input type="file" id="picture" name="picture" accept="image/*" capture="environment" />
    </div>
    <div>
        <img style="max-width: 400px;">
    </div>
        
    <div class="resultArea">
        <pre></pre>
        <!--- テキスト認識の結果を表示 --->
        <table id="textTable">
            <thead>
                <tr>
                    <td><b>テキスト認識結果</b></td>
                </tr>
            </thead>
            <tbody id="textBox"></tbody>
        </table>
    </div>

    <!-- テキスト認識 -->
    <script type="text/javascript">
        // google cloud api key
        const api_key = 'AIzaSyDxY9z3nu72HjAP5dlGuzbLqy1WZlUXBnE';
        const url = 'https://vision.googleapis.com/v1/images:annotate';

        // Cloud Vision APIリクエスト
        const sendAPI = (base64string) => {
            let body = {
                requests: [
                    {
                        image: {content: base64string}, 
                        features: [{type: 'TEXT_DETECTION'}]
                    }
                ]
            };

            let xhr = new XMLHttpRequest();
            xhr.open('POST', `${url}?key=${api_key}`, true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            const p = new Promise((resolve, reject) => {
                xhr.onreadystatechange = () => {
                    if (xhr.readyState != XMLHttpRequest.DONE) return;
                    if (xhr.status >= 400) return reject({message: `Failed with ${xhr.status}:${xhr.statusText}`});
                    resolve(JSON.parse(xhr.responseText));
                };
            })

            xhr.send(JSON.stringify(body));
            return p;
        }

        // ファイル base64変換
        const readFile = (file) => {
            let reader = new FileReader();
            const p = new Promise((resolve, reject) => {
                reader.onload = (ev) => {
                    document.querySelector('img').setAttribute('src', ev.target.result);
                    resolve(ev.target.result.replace(/^data:image\/(png|jpeg);base64,/, ''));
                };
            })
            reader.readAsDataURL(file);

            return p;
        };

        // Event handling
        document.querySelector('input').addEventListener('change', ev => {

            if($("#textBox tr").length){
                $("#textBox tr").remove();
            }

            if (!ev.target.files || ev.target.files.length == 0) return;
            Promise.resolve(ev.target.files[0])
                .then(readFile)
                .then(sendAPI)
                .then(res => {
                console.log('成功!', res);

                if(res.responses[0].textAnnotations){
                    for (var i = 1; i < res.responses[0].textAnnotations.length; i++){
                        var resultText = res.responses[0].textAnnotations[i].description
                        console.log(resultText);

                        var style = 'resultTableContent';
                        if (isNaN(resultText) == false) {
                            var numberDigit = String(resultText).length;
                            if (numberDigit >= 5) {
                                style = 'resultTableContentTarget';
                            }
                        }

                        $("#textBox").append("<tr><td class='" + style + "'>" + resultText + "</td></tr>")

                    }		
                }
            })
            .catch(err => {
                console.log('失敗:', err);
                document.querySelector('pre').innerHTML = JSON.stringify(err, null, 2);
            });
        });

    </script>
</body>
</html>
